<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2d4a6a" />
  <title>Undangan Karina & Alvin — 20 Nov 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;600;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{ --dove:#2d4a6a; --dove-weak:#8aa0b8; --ink:#0f172a; --paper:#ffffff; --muted:#eef2f7; --ring: rgba(45,74,106,.22); }
    html{scroll-behavior:smooth}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--paper);}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    /* --- HERO --- */
    .hero{position:relative;isolation:isolate;color:#fff;overflow:hidden;
      background: radial-gradient(1200px 600px at 20% -10%, #46709c 0%, rgba(70,112,156,0) 60%),
                  radial-gradient(1200px 600px at 120% 10%, #20374f 0%, rgba(32,55,79,0) 65%),
                  linear-gradient(180deg, #385b80 0%, #20364c 100%);
      min-height:100svh;
    }
    .hero-inner{max-width:1100px;margin:0 auto;padding:88px 20px 72px;text-align:center;position:relative;z-index:3;
      display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100svh - 64px);}
    .badge{display:inline-block;padding:8px 14px;border:1.5px solid rgba(255,255,255,.6);border-radius:999px;letter-spacing:.14em;text-transform:uppercase;font-size:12px;background:rgba(255,255,255,.06);backdrop-filter:blur(2px)}
    .basmalah{font-family:'Noto Naskh Arabic',serif;font-size:28px;margin:18px 0 6px;opacity:.95}
    .names{font-family:'Playfair Display',serif;font-weight:700;font-size:clamp(36px,6vw,64px);letter-spacing:.02em;margin:8px 0 8px}
    .meta{opacity:.9;font-weight:600;letter-spacing:.06em;text-transform:uppercase}
    .meta .dot{opacity:.5;padding:0 .5ch}
    .cta-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:22px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .btn.primary{background:#fff;color:var(--dove)}
    .btn.ghost{background:transparent;color:#fff;border:1.5px solid rgba(255,255,255,.6)}
    .wave{position:absolute;left:0;right:0;bottom:0;height:64px;background:linear-gradient(180deg,#20364c 0%,transparent 60%);mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" d="M0,224L48,197.3C96,171,192,117,288,96C384,75,480,85,576,117.3C672,149,768,203,864,208C960,213,1056,171,1152,138.7C1248,107,1344,85,1392,74.7L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/></svg>') center/cover no-repeat}

    /* --- SECTIONS --- */
    .section{max-width:1100px;margin:0 auto;padding:48px 20px}
    .section h2{font-family:'Playfair Display',serif;color:var(--dove);font-size:clamp(22px,3.2vw,32px);margin:0 0 18px}
    .muted{color:#334155}

    /* --- COUNTDOWN --- */
    .count-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .tile{background:var(--muted);border:1px solid #dae3ee;border-radius:16px;padding:18px;text-align:center;box-shadow:0 10px 24px var(--ring)}
    .tile .num{font-family:'Playfair Display',serif;color:var(--dove);font-size:clamp(22px,4.5vw,40px);font-weight:700}
    .tile .lbl{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:#51657e;margin-top:6px}

    /* --- DETAILS --- */
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:#fff;border:1px solid #dbe4ef;border-radius:18px;padding:20px 22px;box-shadow:0 10px 24px var(--ring)}
    .card h3{margin:0 0 12px;font-family:'Playfair Display',serif;color:var(--dove)}
    .pair{display:grid;grid-template-columns:1fr;gap:14px}
    .person{border:1px dashed var(--dove-weak);padding:16px;border-radius:14px;background:#f9fbff}
    .person .name{font-weight:700;color:var(--dove)}
    .person .parents{color:#435568;font-size:14px;margin-top:2px}

    /* media (img/video) di dalam card */
    .card .media{
      margin:0 0 14px;border:1px solid #dbe4ef;border-radius:14px;overflow:hidden;
      box-shadow:0 8px 18px var(--ring);aspect-ratio:16/9;background:#f4f7fb;
    }
    .card .media img,.card .media video{width:100%;height:100%;object-fit:cover;display:block}

    /* --- GALERI (FADE, STORY STYLE) --- */
    .carousel{position:relative;overflow:hidden;}
    .track{position:relative;aspect-ratio:16/9;touch-action:none;user-select:none;}
    .slide{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 2s ease;}
    .slide.active{opacity:1}
    .progress{position:absolute;left:12px;right:12px;top:10px;display:flex;gap:6px;z-index:3}
    .progress .bar{flex:1;height:4px;background:rgba(255,255,255,.35);border-radius:999px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.12) inset}
    .progress .fill{height:100%;width:0%;background:#fff;border-radius:inherit}

    /* --- MAP CARD --- */
    .map-card{position:relative;border:1px solid #dbe4ef;border-radius:16px;overflow:hidden;box-shadow:0 10px 24px var(--ring);}
    .map-card header{position:absolute;left:12px;top:12px;z-index:2;background:rgba(255,255,255,.9);border:1px solid #dbe4ef;padding:8px 10px;border-radius:10px;font-weight:600;color:var(--dove);}
    .map-card .actions{position:absolute;right:12px;bottom:12px;z-index:2;display:flex;gap:8px;}
    .btn.small{padding:8px 12px;border-radius:10px;font-weight:600;border:1px solid #dbe4ef;background:#fff;color:var(--dove);box-shadow:0 8px 16px rgba(0,0,0,.08);}
    .map-card iframe{width:100%;height:100%;aspect-ratio:16/9;border:0;filter:saturate(1.05) contrast(1.05);}

    /* --- LAYOUT: Lokasi & WISHES --- */
    .row{display:grid;grid-template-columns:1fr;gap:32px;}
    @media (min-width:760px){.row{grid-template-columns:1.2fr .8fr;gap:28px;}}

    /* --- MINI AUDIO PLAYER --- */
    .audio-pill{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);display:flex;align-items:center;gap:10px;
      padding:8px 12px 8px 8px;border:1px solid #dbe4ef;border-radius:999px;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);
      box-shadow:0 12px 30px rgba(45,74,106,.25);z-index:60;}
    .audio-pill .aud-btn{width:36px;height:36px;border-radius:50%;border:1px solid #dbe4ef;background:#fff;color:var(--dove);
      display:grid;place-items:center;font-weight:700;cursor:pointer;}
    .audio-pill .meta{min-width:170px;max-width:210px}
    .audio-pill .title{font-weight:600;color:var(--dove);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;}
    .audio-pill .bar{height:4px;background:#e6edf6;border-radius:999px;overflow:hidden;margin-top:6px}
    .audio-pill .fill{height:100%;width:0%;background:var(--dove);transition:width .2s linear}
    @media (max-width:380px){.audio-pill{padding-right:8px}.audio-pill .meta{min-width:140px;max-width:160px}}

    /* --- FOOTER --- */
    footer{background:linear-gradient(180deg,#f3f7fb,#e7eef7);padding:36px 20px;margin-top:20px;border-top:1px solid #d5e1ef}
    .quote{max-width:900px;margin:10px auto 0;border-left:3px solid var(--dove-weak);padding:10px 14px;background:#f8fbff;border-radius:10px}

    /* --- Reveal --- */
    .reveal{opacity:0;transform:translateY(16px);transition:all .7s ease}
    .reveal.on{opacity:1;transform:none}

    /* --- Canvas petals --- */
    #petalsCanvas{position:absolute;inset:0;z-index:2;pointer-events:none;}

    /* ——— WISHES (biru elegan) ——— */
    .wish-form{display:grid;gap:10px;margin:8px 0 14px}
    .wish-form input,.wish-form textarea{
      width:100%; padding:12px 14px; border:1px solid #dbe4ef; border-radius:12px;
      background:#f7faff; color:#1f3550; outline:none;
    }
    .wish-form textarea{min-height:92px; resize:vertical}
    .wish-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .wish-actions .btn{box-shadow:0 10px 24px var(--ring)}
    .wish-hint{color:#51657e}

    .wish-list{list-style:none;margin:6px 0 0;padding:0;display:grid;gap:12px}
    .wish-item{
      display:grid; grid-template-columns:auto 1fr; gap:10px;
      background:linear-gradient(180deg,#f8fbff,#edf4ff);
      border:1px solid #d8e6fb; border-radius:14px; padding:12px 14px;
      box-shadow:0 8px 18px var(--ring);
    }
    .wish-avatar{
      width:36px;height:36px;border-radius:50%;
      display:grid;place-items:center;font-weight:700;
      color:#2d4a6a;background:#e7f0ff;border:1px solid #cfe0ff;
    }
    .wish-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .wish-name{font-weight:700;color:#29486b}
    .wish-time{font-size:12px;color:#6b7f96}
    .wish-msg{white-space:pre-wrap;color:#2b3f58;margin-top:4px}
    .wish-empty{color:#57708f;padding:6px 0}

    /* ===== Wishes: area scroll mandiri ===== */
    .wish-scroll{
      margin-top:10px;
      max-height:360px;          /* tampil 3 kartu kira-kira */
      overflow:auto;
      padding-right:6px;
      overscroll-behavior:contain;
      -webkit-overflow-scrolling:touch;
    }
    .wish-scroll::-webkit-scrollbar{ width:8px; }
    .wish-scroll::-webkit-scrollbar-thumb{ background:rgba(45,74,106,.25); border-radius:999px; }
    .wish-scroll::-webkit-scrollbar-track{ background:transparent; }

/* ===== FIX panjang pesan pada Wishes ===== */
.wish-item{
  grid-template-columns: 44px 1fr;   /* avatar tetap, konten fleksibel */
  align-items: flex-start;
}

.wish-avatar{
  width:44px; height:44px;           /* konsisten dengan grid di atas */
}

/* kolom konten (yang berisi meta + pesan) harus boleh mengecil */
.wish-item > div:last-child{
  min-width: 0;
}

/* bungkus kata super panjang + emoji agar tidak melebar */
.wish-msg{
  white-space: pre-wrap;
  overflow-wrap: anywhere;           /* utama */
  word-break: break-word;            /* fallback Safari lama */
  hyphens: auto;                     /* kalau browser dukung */
}

/* antisipasi nama yang kelewat panjang */
.wish-name{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}
  


</style>
</head>
<body>
  <!-- HERO -->
  <header class="hero" id="hero">
    <canvas id="petalsCanvas"></canvas>
    <div class="hero-inner">
      <div class="badge">KABAR PERNIKAHAN</div>
      <div class="basmalah">بِسْمِ اللّٰهِ الرَّحْمٰنِ الرَّحِيْمِ</div>
      <p style="margin:15px 0 0;opacity:.9">اَلسَّلَامُ عَلَيْكُمْ وَرَحْمَةُ اللهِ وَبَرَكَاتُهُ</p>
      <p style="margin:5px 0 0;opacity:.9">Tanpa mengurangi rasa hormat, kami mewakili keluarga besar ingin mengabarkan acara pernikahan kami yang diselenggarakan secara sederhana.</p>
      <h1 class="names">Karina &amp; Alvin</h1>
      <div class="meta">Kamis, 20 November 2025</div>
      <div class="meta">KJRI Jeddah</div>
      <div class="cta-row">
        <a id="addCalBtn" class="btn primary" href="#">Save to Calendar</a>
        <a class="btn ghost" href="#hitung-mundur">Open Card</a>
      </div>
    </div>
    <div class="wave" aria-hidden="true"></div>
  </header>

  <!-- COUNTDOWN -->
  <section class="section reveal" id="hitung-mundur">
    <h2>Hitung Mundur</h2>
    <div class="count-grid" role="timer" aria-live="polite">
      <div class="tile"><div class="num" id="d">–</div><div class="lbl">Hari</div></div>
      <div class="tile"><div class="num" id="h">–</div><div class="lbl">Jam</div></div>
      <div class="tile"><div class="num" id="m">–</div><div class="lbl">Menit</div></div>
      <div class="tile"><div class="num" id="s">–</div><div class="lbl">Detik</div></div>
    </div>
  </section>

  <!-- DETAILS -->
  <section class="section reveal">
    <div class="grid-2">
      <div class="card">
        <h3>Waktu &amp; Tempat</h3>
        <div class="media">
          <img src="image/kjri-jeddah.png" alt="Gedung KJRI Jeddah" loading="lazy">
        </div>
        <p><strong>Akad:</strong> Kamis, 20 November 2025, <strong>pukul 11:00</strong> (Waktu Jeddah)</p>
        <p><strong>Tempat:</strong> Konsulat Jenderal Republik Indonesia (KJRI) — Jeddah</p>
        <p id="lokasi" style="margin-top:8px"><a href="#" id="mapsLink"></a></p>
      </div>

      <div class="card">
        <h3>Mempelai</h3>
        <div class="media">
          <video src="video/mempelai.mp4" poster="image/mempelai-poster.jpg"
                 autoplay muted loop playsinline
                 onerror="this.outerHTML='<div style=&quot;padding:18px;text-align:center;color:#64748b&quot;>Video mempelai belum tersedia</div>'">
          </video>
        </div>
        <div class="pair">
          <div class="person">
            <div class="name">Karina Dewi Oktaviani</div>
            <div class="parents">Putri dari Bapak Sri Mulyana &amp; Ibu Sri Herlina</div>
          </div>
          <div class="person">
            <div class="name">Alvin Rahman Kautsar</div>
            <div class="parents">Putra dari Bapak Joko Umoro Kalbu &amp; Ibu Saripah</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GALERI (FADE) -->
  <section class="section reveal">
    <h2>Galeri</h2>
    <div class="carousel" id="carousel">
      <div class="track" id="track">
        <img class="slide" src="image/wedding-foto-1.jpeg" alt="Foto 1" onerror="this.outerHTML='<div class=\'slide\' style=\'background:linear-gradient(135deg,#edf2f7,#dbe7f3);display:grid;place-items:center;color:#64748b\'>Letakkan foto kalian di sini (foto 1)</div>'"/>
        <img class="slide" src="image/wedding-foto-2.jpeg" alt="Foto 2" onerror="this.outerHTML='<div class=\'slide\' style=\'background:linear-gradient(135deg,#edf2f7,#dbe7f3);display:grid;place-items:center;color:#64748b\'>Letakkan foto kalian di sini (foto 2)</div>'"/>
        <img class="slide" src="image/wedding-foto-3.jpeg" alt="Foto 3" onerror="this.outerHTML='<div class=\'slide\' style=\'background:linear-gradient(135deg,#edf2f7,#dbe7f3);display:grid;place-items:center;color:#64748b\'>Letakkan foto kalian di sini (foto 3)</div>'"/>
      </div>
    </div>
  </section>

  <!-- LOCATION & WISHES -->
  <section class="section reveal">
    <div class="row">
      <div class="card" id="peta">
        <h3>Lokasi</h3>
        <div class="map-card">
          <header>KJRI Jeddah</header>
          <div class="actions">
            <button class="btn small" id="openMaps">Buka Maps</button>
            <button class="btn small" id="copyAddr">Copy Alamat</button>
          </div>
          <iframe id="mapFrame" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>

      <div class="card">
        <h3>Wishes</h3>
        <form id="wishForm" class="wish-form">
          <input id="wName" type="text" name="name" placeholder="Nama" required />
          <textarea id="wMsg" name="message" placeholder="Tulis ucapan & doa..." required></textarea>
          <div class="wish-actions">
            <button class="btn primary" id="wishSend" type="submit">Kirim</button>
            <span class="wish-hint" id="wishStatus"></span>
          </div>
        </form>

        <!-- area list dengan scroll sendiri -->
        <div class="wish-scroll">
          <ul class="wish-list" id="wishList">
            <li class="wish-empty">Belum ada ucapan. Jadilah yang pertama ✨</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="section" style="padding-top:0">
      <div class="quote">
        <p>“Dan segala sesuatu Kami ciptakan berpasang-pasangan agar kamu mengingat (kebesaran Allah).” <strong>(QS. Adh-Dhariyat: 49)</strong></p>
      </div>
      <div class="quote" style="margin-top:10px">
        <p>“Dan sesungguhnya Dialah yang menciptakan pasangan laki-laki dan perempuan.” <strong>(QS. An-Najm: 45)</strong></p>
      </div>
      <p style="text-align:center;margin-top:18px;color:#475569">Terima kasih atas doa dan kehadiran Anda.</p>
    </div>
  </footer>

  <!-- Mini Player -->
  <div class="audio-pill" id="audioPill" aria-live="polite">
    <button class="aud-btn" id="audioToggle" aria-label="Putar musik">▶</button>
    <div class="meta">
      <span class="title" id="audTitle">Somewhere Only We Know</span>
      <div class="bar"><span class="fill" id="audFill"></span></div>
    </div>
    <audio id="bgm" src="audio/lagu.mp3" preload="auto" loop playsinline muted autoplay></audio>
  </div>

  <script>
    // ====== CONFIG ======
    const EVENT_ISO = '2025-11-20T11:00:00+03:00';
    const MAPS_Q = 'KJRI Jeddah';
    const MAPS_URL = 'https://maps.google.com/?q=' + encodeURIComponent(MAPS_Q);

    // ====== ADD TO CALENDAR (.ics) ======
    function buildICS(){
      const dt = new Date(EVENT_ISO);
      const start = dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
      const end = new Date(dt.getTime()+60*60*1000).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Undangan Karina & Alvin//ID
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
DTSTART:${start}
DTEND:${end}
SUMMARY:Akad Nikah — Karina & Alvin
LOCATION:${MAPS_Q}
DESCRIPTION:Akad Nikah Karina & Alvin (pukul 11:00 waktu Jeddah)
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], {type:'text/calendar'});
      return URL.createObjectURL(blob);
    }
    document.getElementById('addCalBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      const url = buildICS();
      const a = document.createElement('a');
      a.href = url; a.download = 'Karina-Alvin-20Nov2025.ics';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    });

    // ====== MAPS ======
    document.getElementById('mapsLink').setAttribute('href', MAPS_URL);
    document.getElementById('openMaps').addEventListener('click', ()=> window.open(MAPS_URL, '_blank'));
    document.getElementById('copyAddr').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(MAPS_Q); alert('Alamat tersalin: '+MAPS_Q); }catch{ alert('Gagal menyalin alamat'); }
    });
    document.getElementById('mapFrame').src = 'https://www.google.com/maps?q=' + encodeURIComponent(MAPS_Q) + '&output=embed';

    // ====== COUNTDOWN ======
    const dEl=document.getElementById('d'), hEl=document.getElementById('h'), mEl=document.getElementById('m'), sEl=document.getElementById('s');
    function tick(){
      const now = new Date(), target = new Date(EVENT_ISO);
      let diff = Math.max(0, target - now);
      const days = Math.floor(diff / 86400000); diff -= days*86400000;
      const hours = Math.floor(diff / 3600000); diff -= hours*3600000;
      const mins = Math.floor(diff / 60000); diff -= mins*60000;
      const secs = Math.floor(diff / 1000);
      dEl.textContent=String(days);
      hEl.textContent=String(hours).padStart(2,'0');
      mEl.textContent=String(mins).padStart(2,'0');
      sEl.textContent=String(secs).padStart(2,'0');
    }
    tick(); setInterval(tick, 1000);

    // ====== REVEAL ON SCROLL ======
    const io = new IntersectionObserver((es)=>{es.forEach(e=>{if(e.isIntersecting)e.target.classList.add('on');})},{threshold:.14});
    document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

    // ====== GALERI (FADE + AUTO) ======
    const carousel = document.getElementById('carousel');
    const track = document.getElementById('track');
    const slides = Array.from(track.querySelectorAll('.slide'));
    const progress = document.createElement('div');
    progress.className = 'progress'; progress.id = 'progress';
    progress.innerHTML = slides.map(() => '<span class="bar"><span class="fill"></span></span>').join('');
    carousel.appendChild(progress);
    const fills = Array.from(progress.querySelectorAll('.fill'));
    let gIndex = 0, startTs = null, elapsed = 0, paused = false;
    const DURATION = 2000;
    function show(i){
      const n = slides.length; if(!n) return; gIndex=(i+n)%n;
      slides.forEach((el,idx)=>el.classList.toggle('active',idx===gIndex));
      fills.forEach((f,idx)=>f.style.width = idx<gIndex?'100%':'0%'); elapsed=0; startTs=null;
    }
    show(0);
    function step(ts){
      if(paused){requestAnimationFrame(step);return;}
      if(startTs==null) startTs=ts-elapsed;
      elapsed = ts-startTs;
      const p = Math.min(1, elapsed/DURATION);
      if(fills[gIndex]) fills[gIndex].style.width=(p*100).toFixed(2)+'%';
      if(p>=1){show(gIndex+1); startTs=ts;}
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
    [carousel,track].forEach(el=>{
      el.addEventListener('pointerdown',()=>{paused=true;});
      el.addEventListener('pointerup',()=>{paused=false;});
      el.addEventListener('pointercancel',()=>{paused=false;});
      el.addEventListener('pointerleave',()=>{paused=false;});
    });
    document.addEventListener('visibilitychange',()=>{paused=document.hidden;});

    // ====== CANVAS PETALS ======
    const canvas = document.getElementById('petalsCanvas');
    const hero = document.getElementById('hero');
    const ctx = canvas.getContext('2d');
    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let W=0,H=0,DPR=Math.min(2,window.devicePixelRatio||1);
    function resizeCanvas(){
      W=hero.clientWidth; H=hero.clientHeight;
      canvas.width=Math.max(1,Math.floor(W*DPR));
      canvas.height=Math.max(1,Math.floor(H*DPR));
      canvas.style.width=W+'px'; canvas.style.height=H+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    resizeCanvas(); window.addEventListener('resize',resizeCanvas);
    function rand(a,b){return a+Math.random()*(b-a)}
    const COUNT=reduce?12:28;
    const petals=Array.from({length:COUNT},()=>spawn());
    function spawn(){return{x:rand(0,W),y:rand(-H,0),r:rand(8,18),vy:rand(25,55),vx:rand(-10,10),rot:rand(0,Math.PI*2),vr:rand(-0.8,0.8),sway:rand(0.8,1.6),hue:rand(205,215)}}
    let last=performance.now();
    function drawFlower(x,y,r,rot,hue){
      ctx.save(); ctx.translate(x,y); ctx.rotate(rot);
      const petalCount=5;
      for(let i=0;i<petalCount;i++){
        ctx.rotate((Math.PI*2)/petalCount);
        ctx.beginPath();
        ctx.ellipse(0,r*0.55,r*0.38,r*0.22,0,0,Math.PI*2);
        const grad=ctx.createRadialGradient(0,r*0.55,r*0.05,0,r*0.55,r*0.45);
        grad.addColorStop(0,`hsla(${hue},60%,92%,.95)`); grad.addColorStop(1,`hsla(${hue},55%,60%,.85)`);
        ctx.fillStyle=grad; ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.lineWidth=.8; ctx.stroke();
      }
      ctx.beginPath(); ctx.arc(0,0,r*0.22,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.85)'; ctx.fill(); ctx.restore();
    }
    function loop(t){
      const dt=Math.min(0.05,(t-last)/1000); last=t; ctx.clearRect(0,0,W,H);
      for(const p of petals){
        p.y+=p.vy*dt; p.x+=(p.vx+Math.sin((t*0.001)+p.y*0.02)*12*p.sway)*dt; p.rot+=p.vr*dt; drawFlower(p.x,p.y,p.r,p.rot,p.hue);
        if(p.y-p.r>H+10){const np=spawn(); np.y=-np.r; Object.assign(p,np);}
      } requestAnimationFrame(loop);
    } requestAnimationFrame(loop);

    // ====== AUDIO MINI PLAYER ======
    const audio=document.getElementById('bgm');
    const audBtn=document.getElementById('audioToggle');
    const audFill=document.getElementById('audFill');
    const audTitle=document.getElementById('audTitle');
    audTitle.textContent='Somewhere Only We Know';
    audio.volume=0.85;
    function updateUI(){
      const isAudible=!audio.muted && !audio.paused;
      audBtn.textContent=isAudible?'❚❚':'▶';
      audBtn.setAttribute('aria-label',isAudible?'Jeda musik':'Putar musik');
      const p=(audio.duration?(audio.currentTime/audio.duration):0)*100; audFill.style.width=p+'%';
    }
    updateUI();
    audBtn.addEventListener('click',async ()=>{
      try{
        if(audio.paused){audio.muted=false; await audio.play();}
        else if(audio.muted){audio.muted=false;}
        else{audio.pause();}
      }catch(e){} updateUI();
    });
    audio.addEventListener('timeupdate',updateUI);
    audio.addEventListener('play',updateUI);
    audio.addEventListener('pause',updateUI);
    audio.addEventListener('ended',updateUI);
    document.addEventListener('visibilitychange',()=>{if(document.hidden) audio.pause(); else audio.play().catch(()=>{});});

    // Autoplay aman (mute -> unmute + fade-in saat memungkinkan)
    (async function initAutoplay(){
      const TARGET_VOL=0.85; audio.muted=true; audio.volume=0;
      const tryPlaySilent=async()=>{try{await audio.play();}catch{}};
      if(document.readyState==='complete'||document.readyState==='interactive'){tryPlaySilent();}
      else{document.addEventListener('DOMContentLoaded',tryPlaySilent,{once:true});}
      const tryUnmute=async()=>{
        try{
          audio.muted=false; if(audio.paused) await audio.play();
          let v=0; const step=()=>{v=Math.min(TARGET_VOL,v+0.05); audio.volume=v; if(v<TARGET_VOL) requestAnimationFrame(step);};
          requestAnimationFrame(step); updateUI(); detach();
        }catch(e){}
      };
      [200,600,1200].forEach(t=>setTimeout(tryUnmute,t));
      function onFirstGesture(){audio.muted=false; if(audio.paused) audio.play().catch(()=>{}); let v=0; audio.volume=0;
        const step=()=>{v=Math.min(TARGET_VOL,v+0.05); audio.volume=v; if(v<TARGET_VOL) requestAnimationFrame(step);};
        requestAnimationFrame(step); updateUI(); detach();
      }
      function detach(){['pointerdown','touchstart','click','keydown'].forEach(ev=>document.removeEventListener(ev,onFirstGesture,true));}
      ['pointerdown','touchstart','click','keydown'].forEach(ev=>document.addEventListener(ev,onFirstGesture,{once:true,passive:true,capture:true}));
    })();

    /* ====== WISHES (Google Sheets) ====== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxzEAu2bV6sYEPJqbSBLshXubUi1MgHHy5DACp_l2wYlzW2wr9MEgouITUfQX_eWHXo/exec';
    const wishForm = document.getElementById('wishForm');
    const wName    = document.getElementById('wName');
    const wMsg     = document.getElementById('wMsg');
    const wStatus  = document.getElementById('wishStatus');
    const wishList = document.getElementById('wishList');
    const wishScroll = document.querySelector('.wish-scroll'); // <- pembungkus scroll

    let ALL_WISHES = []; // cache lokal

    // util
    const esc = s => String(s ?? '').replace(/[&<>\"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const initial = s => (s||'?').trim().charAt(0).toUpperCase();
    const parseTS = (s) => {
      if (!s) return new Date();
      const m = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})[\s,]*(\d{1,2})?:?(\d{2})?/);
      if (m) { const [_, d, mo, y, hh='0', mm='0'] = m; return new Date(Number(y.length===2?('20'+y):y), Number(mo)-1, Number(d), Number(hh), Number(mm)); }
      const t = Date.parse(s); return isNaN(t) ? new Date() : new Date(t);
    };
    const timeAgo = (isoLike) => {
      const d = Math.max(1, Math.floor((Date.now() - parseTS(isoLike).getTime())/1000));
      if (d < 60) return `${d} dtk lalu`;
      const m = Math.floor(d/60); if (m < 60) return `${m} mnt lalu`;
      const h = Math.floor(m/60); if (h < 24) return `${h} jam lalu`;
      const a = Math.floor(h/24); return `${a} hari lalu`;
    };

    function renderWishes(rows){
      ALL_WISHES = rows;
      wishList.innerHTML = '';
      if(!rows || !rows.length){
        wishList.innerHTML = '<li class="wish-empty">Belum ada ucapan. Jadilah yang pertama ✨</li>';
        if (wishScroll) wishScroll.scrollTop = 0;
        return;
      }
      for(const r of rows){
        const li = document.createElement('li');
        li.className = 'wish-item';
        li.innerHTML = `
          <div class="wish-avatar">${esc(initial(r.name))}</div>
          <div>
            <div class="wish-meta">
              <span class="wish-name">${esc(r.name)}</span>
              <span class="wish-time">${esc(timeAgo(r.timestamp))}</span>
            </div>
            <div class="wish-msg">${esc(r.message)}</div>
          </div>`;
        wishList.appendChild(li);
      }
      if (wishScroll) wishScroll.scrollTop = 0; // reset ke atas (terbaru dulu)
    }

    async function fetchJSON(url, opts){
      const res = await fetch(url, { cache:'no-store', ...opts });
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return txt; }
    }
    function normalizeRows(raw){
      if (Array.isArray(raw)) return raw;
      if (raw && raw.rows) return raw.rows;
      if (raw && raw.ok && raw.rows) return raw.rows;
      return [];
    }
    async function loadWishes(){
      try{
        const data = await fetchJSON(`${SHEETS_WEBAPP_URL}?limit=100&nocache=${Date.now()}`);
        const rows = normalizeRows(data)
          .map(r => ({ timestamp: r.timestamp ?? r.time ?? r[0], name: (r.name ?? r[1] ?? '').trim(), message: (r.message ?? r[2] ?? '').trim() }))
          .filter(r => r.name && r.message);
        renderWishes(rows);
      }catch(e){ console.warn('loadWishes error', e); }
    }

    let sending = false;
    wishForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(sending) return;
      const name = wName.value.trim(), message = wMsg.value.trim();
      if(!name || !message){ wStatus.textContent = 'Nama & ucapan wajib diisi.'; return; }

      const last = +localStorage.getItem('w_last') || 0;
      if(Date.now() - last < 10_000){ wStatus.textContent = 'Tunggu sebentar sebelum mengirim lagi 🙏'; return; }

      sending = true;
      wStatus.textContent = 'Mengirim...';
      try{
        const resp = await fetchJSON(SHEETS_WEBAPP_URL, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify({ name, message })
        });
        const ok = (resp && resp.ok === true) || (typeof resp === 'string' && /ok/i.test(resp));
        if(ok){
          wMsg.value = '';
          wStatus.textContent = 'Terkirim. Terima kasih! 💙';
          localStorage.setItem('w_last', String(Date.now()));
          renderWishes([{ timestamp:new Date().toISOString(), name, message }, ...ALL_WISHES]);
          loadWishes();
        }else{
          wStatus.textContent = 'Gagal mengirim. Coba lagi.';
        }
      }catch(err){
        console.warn(err);
        wStatus.textContent = 'Gagal mengirim (koneksi?).';
      }finally{
        sending = false;
        setTimeout(()=> wStatus.textContent = '', 3500);
      }
    });

    loadWishes();

    // ====== Event done note ======
    (function(){
      const target=new Date(EVENT_ISO);
      if(Date.now()>+target){
        const c=document.getElementById('hitung-mundur');
        c.querySelector('h2').textContent='Acara telah berlangsung';
        c.querySelector('.count-grid').outerHTML='<p class="muted">Alhamdulillah, acara telah diselenggarakan. Terima kasih atas doa dan kehadiran Anda.</p>';
      }
    })();
  </script>
</body>
</html>
